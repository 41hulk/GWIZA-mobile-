{"ast":null,"code":"'use strict';var Queue=require('tiny-queue');var immediate=require('immediate');var noop=require('noop-fn');var WebSQLTransaction=require(\"./WebSQLTransaction\");var ROLLBACK=[{sql:'ROLLBACK;',args:[]}];var COMMIT=[{sql:'END;',args:[]}];function TransactionTask(readOnly,txnCallback,errorCallback,successCallback){this.readOnly=readOnly;this.txnCallback=txnCallback;this.errorCallback=errorCallback;this.successCallback=successCallback;}function WebSQLDatabase(dbVersion,db){this.version=dbVersion;this._db=db;this._txnQueue=new Queue();this._running=false;this._currentTask=null;}WebSQLDatabase.prototype._onTransactionComplete=function(err){var self=this;function done(){if(err){self._currentTask.errorCallback(err);}else{self._currentTask.successCallback();}self._running=false;self._currentTask=null;self._runNextTransaction();}if(self._currentTask.readOnly){done();}else if(err){self._db.exec(ROLLBACK,false,done);}else{self._db.exec(COMMIT,false,done);}};WebSQLDatabase.prototype._runTransaction=function(){var self=this;var txn=new WebSQLTransaction(self);immediate(function(){self._currentTask.txnCallback(txn);txn._checkDone();});};WebSQLDatabase.prototype._runNextTransaction=function(){if(this._running){return;}var task=this._txnQueue.shift();if(!task){return;}this._currentTask=task;this._running=true;this._runTransaction();};WebSQLDatabase.prototype._createTransaction=function(readOnly,txnCallback,errorCallback,successCallback){errorCallback=errorCallback||noop;successCallback=successCallback||noop;if(typeof txnCallback!=='function'){throw new Error('The callback provided as parameter 1 is not a function.');}this._txnQueue.push(new TransactionTask(readOnly,txnCallback,errorCallback,successCallback));this._runNextTransaction();};WebSQLDatabase.prototype.transaction=function(txnCallback,errorCallback,successCallback){this._createTransaction(false,txnCallback,errorCallback,successCallback);};WebSQLDatabase.prototype.readTransaction=function(txnCallback,errorCallback,successCallback){this._createTransaction(true,txnCallback,errorCallback,successCallback);};module.exports=WebSQLDatabase;","map":{"version":3,"sources":["/Users/ntareguy/Downloads/gwizamobile1/node_modules/@expo/websql/lib/websql/WebSQLDatabase.js"],"names":["Queue","require","immediate","noop","WebSQLTransaction","ROLLBACK","sql","args","COMMIT","TransactionTask","readOnly","txnCallback","errorCallback","successCallback","WebSQLDatabase","dbVersion","db","version","_db","_txnQueue","_running","_currentTask","prototype","_onTransactionComplete","err","self","done","_runNextTransaction","exec","_runTransaction","txn","_checkDone","task","shift","_createTransaction","Error","push","transaction","readTransaction","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar Queue = require('tiny-queue');\nvar immediate = require('immediate');\nvar noop = require('noop-fn');\n\nvar WebSQLTransaction = require('./WebSQLTransaction');\n\nvar ROLLBACK = [\n  {sql: 'ROLLBACK;', args: []}\n];\n\nvar COMMIT = [\n  {sql: 'END;', args: []}\n];\n\n// v8 likes predictable objects\nfunction TransactionTask(readOnly, txnCallback, errorCallback, successCallback) {\n  this.readOnly = readOnly;\n  this.txnCallback = txnCallback;\n  this.errorCallback = errorCallback;\n  this.successCallback = successCallback;\n}\n\nfunction WebSQLDatabase(dbVersion, db) {\n  this.version = dbVersion;\n  this._db = db;\n  this._txnQueue = new Queue();\n  this._running = false;\n  this._currentTask = null;\n}\n\nWebSQLDatabase.prototype._onTransactionComplete = function(err) {\n  var self = this;\n\n  function done() {\n    if (err) {\n      self._currentTask.errorCallback(err);\n    } else {\n      self._currentTask.successCallback();\n    }\n    self._running = false;\n    self._currentTask = null;\n    self._runNextTransaction();\n  }\n\n  if (self._currentTask.readOnly) {\n    done(); // read-only doesn't require a transaction\n  } else if (err) {\n    self._db.exec(ROLLBACK, false, done);\n  } else {\n    self._db.exec(COMMIT, false, done);\n  }\n};\n\nWebSQLDatabase.prototype._runTransaction = function () {\n  var self = this;\n  var txn = new WebSQLTransaction(self);\n\n  immediate(function () {\n    self._currentTask.txnCallback(txn);\n    txn._checkDone();\n  });\n};\n\nWebSQLDatabase.prototype._runNextTransaction = function() {\n  if (this._running) {\n    return;\n  }\n  var task = this._txnQueue.shift();\n\n  if (!task) {\n    return;\n  }\n\n  this._currentTask = task;\n  this._running = true;\n  this._runTransaction();\n};\n\nWebSQLDatabase.prototype._createTransaction = function(\n    readOnly, txnCallback, errorCallback, successCallback) {\n  errorCallback = errorCallback || noop;\n  successCallback = successCallback || noop;\n\n  if (typeof txnCallback !== 'function') {\n    throw new Error('The callback provided as parameter 1 is not a function.');\n  }\n\n  this._txnQueue.push(new TransactionTask(readOnly, txnCallback, errorCallback, successCallback));\n  this._runNextTransaction();\n};\n\nWebSQLDatabase.prototype.transaction = function (txnCallback, errorCallback, successCallback) {\n  this._createTransaction(false, txnCallback, errorCallback, successCallback);\n};\n\nWebSQLDatabase.prototype.readTransaction = function (txnCallback, errorCallback, successCallback) {\n  this._createTransaction(true, txnCallback, errorCallback, successCallback);\n};\n\nmodule.exports = WebSQLDatabase;"]},"metadata":{},"sourceType":"script"}